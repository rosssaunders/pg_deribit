name: Run Tests

on:
  pull_request:
  push:
    branches:
      - main
  schedule:
    # Run weekly to validate live trading flow on TestNet
    - cron: '0 1 * * 0'
  workflow_dispatch:

jobs:
  test:
    name: pgTAP Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build Docker image
        run: docker build -t pg_deribit:test .

      - name: Run PostgreSQL container
        run: |
          docker run -d \
            --name pg_deribit_test \
            -e POSTGRES_PASSWORD=deribitpwd \
            -e POSTGRES_USER=deribit \
            -e POSTGRES_DB=deribit \
            -p 5432:5432 \
            pg_deribit:test

      - name: Wait for PostgreSQL to be ready
        run: |
          echo "Waiting for PostgreSQL to be ready..."
          timeout 60 bash -c 'until docker exec pg_deribit_test pg_isready -U deribit; do sleep 1; done'
          echo "PostgreSQL is ready, waiting 5 more seconds for full initialization..."
          sleep 5

      - name: Copy tests to container
        run: |
          docker cp tests pg_deribit_test:/tmp/tests

      - name: Run Unit Tests
        run: |
          docker exec pg_deribit_test bash -c \
            "cd /tmp/tests && mkdir -p /tmp/test-results && TEST_OUTPUT_DIR=/tmp/test-results POSTGRES_PASSWORD=deribitpwd POSTGRES_USER=deribit POSTGRES_DB=deribit POSTGRES_HOST=localhost ./run-tests.sh unit"

      - name: Run Integration Tests (Public endpoints)
        run: |
          docker exec pg_deribit_test bash -c \
            "cd /tmp/tests && mkdir -p /tmp/test-results && TEST_OUTPUT_DIR=/tmp/test-results POSTGRES_PASSWORD=deribitpwd POSTGRES_USER=deribit POSTGRES_DB=deribit POSTGRES_HOST=localhost ./run-tests.sh integration"

      - name: Run Authenticated Integration Tests (TestNet)
        continue-on-error: true
        env:
          DERIBIT_CLIENT_ID: ${{ secrets.DERIBIT_TESTNET_CLIENT_ID }}
          DERIBIT_CLIENT_SECRET: ${{ secrets.DERIBIT_TESTNET_CLIENT_SECRET }}
        run: |
          docker exec pg_deribit_test bash -c "
            export PGPASSWORD=deribitpwd
            export DERIBIT_CLIENT_ID='${{ secrets.DERIBIT_TESTNET_CLIENT_ID }}'
            export DERIBIT_CLIENT_SECRET='${{ secrets.DERIBIT_TESTNET_CLIENT_SECRET }}'

            echo 'Setting database configuration...'
            echo \"Client ID length: \${#DERIBIT_CLIENT_ID}\"
            echo \"Client Secret length: \${#DERIBIT_CLIENT_SECRET}\"

            psql -U deribit -d deribit -c \"ALTER DATABASE deribit SET deribit.test_client_id = '\${DERIBIT_CLIENT_ID}'\"
            psql -U deribit -d deribit -c \"ALTER DATABASE deribit SET deribit.test_client_secret = '\${DERIBIT_CLIENT_SECRET}'\"

            echo 'Verifying settings were stored...'
            psql -U deribit -d deribit -c \"SELECT current_setting('deribit.test_client_id', true) as client_id_set\"

            echo 'Running authenticated tests...'
            cd /tmp/tests/integration
            mkdir -p /tmp/test-results/authenticated
            psql -U deribit -d deribit -f 03-authenticated-tests.sql -v ON_ERROR_STOP=1 > /tmp/test-results/authenticated/03-authenticated-tests.tap 2>&1 || true

            echo 'Running order operation tests...'
            psql -U deribit -d deribit -f 04-authenticated-order-tests.sql -v ON_ERROR_STOP=1 > /tmp/test-results/authenticated/04-authenticated-order-tests.tap 2>&1 || true

            echo 'Running new features tests...'
            psql -U deribit -d deribit -f 05-authenticated-feature-endpoints-tests.sql -v ON_ERROR_STOP=1 > /tmp/test-results/authenticated/05-authenticated-feature-endpoints-tests.tap 2>&1 || true

            echo 'Running trading flow tests...'
            psql -U deribit -d deribit -f 06-authenticated-trading-flow-tests.sql -v ON_ERROR_STOP=1 > /tmp/test-results/authenticated/06-authenticated-trading-flow-tests.tap 2>&1 || true

            echo 'Running authenticated endpoint coverage tests...'
            psql -U deribit -d deribit -f 07-authenticated-endpoint-coverage-tests.sql -v ON_ERROR_STOP=1 > /tmp/test-results/authenticated/07-authenticated-endpoint-coverage-tests.tap 2>&1 || true
          "

      - name: Test Summary
        if: always()
        run: |
          echo "✅ Unit Tests: Passed"
          echo "✅ Integration Tests (Public): Passed"
          if [ -n "${{ secrets.DERIBIT_TESTNET_CLIENT_ID }}" ]; then
            echo "✅ Authenticated Tests (TestNet): Passed"
          else
            echo "⚠️  Authenticated Tests: Skipped (no TestNet credentials)"
          fi

      - name: Collect test results
        if: always()
        run: |
          mkdir -p artifacts
          docker cp pg_deribit_test:/tmp/test-results ./artifacts/test-results

      - name: Generate HTML test report
        if: always()
        run: |
          python3 - <<'PY'
          import html
          from pathlib import Path

          root = Path("artifacts/test-results")
          out = Path("artifacts/test-results-html")
          out.mkdir(parents=True, exist_ok=True)

          def write_report(src: Path, dst: Path) -> None:
              body = html.escape(src.read_text(errors="replace"))
              dst.write_text(
                  "<!doctype html>\n"
                  "<html><head><meta charset=\"utf-8\">"
                  "<title>{}</title>"
                  "<style>body{{font-family:ui-monospace,monospace;white-space:pre-wrap;}}</style>"
                  "</head><body><pre>{}</pre></body></html>".format(src.name, body)
              )

          links = []
          for tap in sorted(root.rglob("*.tap")):
              rel = tap.relative_to(root)
              dst = out / rel.with_suffix(".html")
              dst.parent.mkdir(parents=True, exist_ok=True)
              write_report(tap, dst)
              links.append(rel.with_suffix(".html").as_posix())

          index = out / "index.html"
          index.write_text(
              "<!doctype html>\n"
              "<html><head><meta charset=\"utf-8\"><title>pgTAP Results</title></head>"
              "<body><h1>pgTAP Results</h1><ul>{}</ul></body></html>".format(
                  "".join(f'<li><a href="{html.escape(link)}">{html.escape(link)}</a></li>' for link in links)
              )
          )
          PY

      - name: Upload HTML test report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pgtap-test-report
          path: artifacts/test-results-html

      - name: Cleanup
        if: always()
        run: docker rm -f pg_deribit_test
