# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

pg_deribit is a PostgreSQL extension that provides a wrapper for the Deribit cryptocurrency trading API. It enables developers to interact with Deribit's trading platform directly from PostgreSQL using SQL functions.

The extension is built on top of Omnigres (specifically `omni_http` and `omni_httpc`) for HTTP functionality and generates SQL wrapper functions for all Deribit API endpoints.

## Architecture

### Extension Structure

The extension follows PGXN (PostgreSQL Extension Network) conventions:

- **pg_deribit.control**: Extension metadata (version 1.0, requires pgcrypto, omni_http, omni_httpc)
- **sql/pg_deribit--1.0.sql**: The compiled extension file containing all SQL
- **Makefile**: PostgreSQL extension build system using PGXS

### Code Organization

```
sql/
├── schema/          - Schema definition (deribit schema)
├── types/           - Custom types (auth, internal_error)
├── sequences/       - Sequence definitions
├── tables/          - Internal tables (rate limiting, call logging, archiving)
├── functions/       - Core infrastructure functions
│   ├── auth.sql                    - Authentication management (set_client_auth, get_auth)
│   ├── environment.sql             - TestNet/Production switching
│   ├── public_jsonrpc_request.sql  - Public API calls
│   ├── private_jsonrpc_request.sql - Authenticated API calls
│   ├── private_build_auth_headers.sql - OAuth header construction
│   └── internal_url_endpoint.sql   - URL construction
├── helpers/         - Convenience functions (login helpers)
├── endpoints/       - Generated API endpoint wrappers (200+ files)
└── extensions/      - Required extension declarations

codegen/            - Python code generator
├── main.py         - Entry point: downloads OpenAPI specs, generates SQL
├── deribit/        - OpenAPI parsing and extraction
├── postgres/       - SQL generation logic
├── models/         - Data models for API endpoints
└── utils/          - Helper utilities
```

### How the Extension Works

1. **Authentication**: Users call `deribit.set_client_auth(client_id, client_secret)` to store credentials in session variables
2. **API Calls**: Each Deribit endpoint has a corresponding PostgreSQL function (e.g., `deribit.public_get_currencies()`)
3. **Request Flow**:
   - Endpoint functions call `private_jsonrpc_request` or `public_jsonrpc_request`
   - These build JSON-RPC requests and call the Deribit API via `omni_http`
   - Responses are parsed and returned as PostgreSQL result sets
4. **Call Logging**: All requests are logged to `matching_engine_request_call_log` or `non_matching_engine_request_call_log` tables
5. **Rate Limiting**: Tracked in `internal_endpoint_rate_limit` table

### Generated Code

The `sql/endpoints/` directory contains **auto-generated** SQL files - one per Deribit API endpoint. These are generated by the Python codegen tool and should not be manually edited. To regenerate:

```bash
cd codegen
python -m venv venv
source venv/bin/activate  # or .\venv\Scripts\activate on Windows
pip install -r requirements.txt
python main.py
```

The generator:
1. Downloads Deribit OpenAPI specs
2. Normalizes them into a JSON snapshot (deribit.json)
3. Generates SQL wrapper functions for each endpoint

## Common Commands

### Building and Testing Locally

```bash
# Build the extension SQL file
make

# Test locally with Docker
docker build -t pg_deribit .
docker run -d --name pg_deribit -p 5433:5432 \
  -e POSTGRES_PASSWORD=deribitpwd \
  -e POSTGRES_USER=deribit \
  -e POSTGRES_DB=deribit \
  pg_deribit

# Connect and test
PGPASSWORD=deribitpwd psql -h localhost -p 5433 -U deribit -d deribit
```

### Using the Published Image

```bash
# Pull from GitHub Container Registry
docker pull ghcr.io/rosssaunders/pg_deribit:latest

# Run
docker run -d --name pg_deribit -p 5433:5432 \
  -e POSTGRES_PASSWORD=deribitpwd \
  -e POSTGRES_USER=deribit \
  -e POSTGRES_DB=deribit \
  ghcr.io/rosssaunders/pg_deribit:latest

# Install extension
PGPASSWORD=deribitpwd psql -h localhost -p 5433 -U deribit -d deribit \
  -c "create extension if not exists pg_deribit cascade;"
```

### Linting

SQL code should be formatted using sqlfluff (mentioned in CONTRIBUTING.md).

### Regenerating Endpoint Wrappers

When Deribit updates their API:

```bash
cd codegen
python main.py  # Downloads latest docs and regenerates sql/endpoints/
cd ..
make           # Rebuild the extension
```

## Testing

### Test Structure

The project uses pgTAP for automated testing with a three-tier approach:

```
tests/
├── unit/                    # Fast, isolated tests (~1 second)
│   ├── 00-setup.sql        # Extension loading
│   ├── 01-auth-tests.sql   # Authentication functions
│   ├── 02-helper-tests.sql # Helper utilities
│   └── 03-schema-tests.sql # Schema and type definitions
├── integration/             # API tests (requires network)
│   ├── 00-setup.sql        # Integration setup
│   └── 01-public-api-tests.sql # Public endpoint tests
└── run-tests.sh            # Test runner script
```

### Running Tests

```bash
# Run all tests
make test

# Run only unit tests (fast, no network required)
make test-unit

# Run only integration tests (requires Deribit API access)
make test-integration

# Or use the test runner directly
cd tests
./run-tests.sh              # All tests
./run-tests.sh unit         # Unit tests only
./run-tests.sh integration  # Integration tests only
```

### Writing Tests

Use pgTAP assertion functions:

```sql
begin;

create extension if not exists pgtap;
create extension if not exists pg_deribit cascade;

select plan(3);

-- Test function exists
select has_function('deribit', 'public_test', 'public_test should exist');

-- Test function returns data
select ok(
    (select deribit.public_test() is not null),
    'public_test should return data'
);

-- Test specific behavior
select is(
    current_setting('deribit.testnet', true)::boolean,
    false,
    'TestNet should be disabled by default'
);

select * from finish();
rollback;
```

### Manual Testing Examples

The `doc/examples/` directory contains comprehensive manual testing scripts demonstrating:
- Public API usage (currencies, instruments, orderbook)
- Private API with authentication (orders, deposits, transfers)
- Advanced patterns (pagination, recursive CTEs)

These can be adapted into integration or E2E tests as needed.

### CI/CD Testing

Tests run automatically on:
- All pull requests
- Pushes to main branch
- Manual workflow dispatch

See `.github/workflows/test.yml` for details.

## Docker Build Considerations

**CRITICAL**: The Dockerfile must use the correct `pg_config` for the PostgreSQL version running in the container.

The base image `ghcr.io/omnigres/omnigres-17:latest` has both PostgreSQL 17 (running) and 18 (default pg_config). The Makefile must specify `PG_CONFIG=/usr/lib/postgresql/17/bin/pg_config` to ensure extension files install to the correct location (`/usr/share/postgresql/17/extension/`).

Current Dockerfile pattern:
```dockerfile
RUN make PG_CONFIG=/usr/lib/postgresql/17/bin/pg_config && \
    make install PG_CONFIG=/usr/lib/postgresql/17/bin/pg_config
```

## Build System

The Makefile concatenates SQL files in a specific order:
1. types/*.sql (non-generated)
2. sequences/*.sql (non-generated)
3. tables/*.sql (non-generated)
4. functions/*.sql (non-generated)
5. triggers/*.sql (non-generated)
6. static/*.sql (non-generated)
7. *.gen.sql files (generated, in same category order)
8. endpoints/*.sql (all generated)

Output: `sql/pg_deribit--1.0.sql`

## Session Configuration

The extension uses PostgreSQL session variables for authentication:
- `deribit.client_id`
- `deribit.client_secret`
- `deribit.access_token`
- `deribit.refresh_token`
- `deribit.testnet` (boolean for TestNet mode)

## CI/CD

- **test.yml**: Runs pgTAP unit and integration tests on all PRs and pushes to main
- **publish-docker-image.yml**: Builds and publishes Docker image to GHCR on push to main
- **weekly-api-check.yml**: Checks for Deribit API changes weekly
